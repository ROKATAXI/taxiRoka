{% extends 'base.html' %}
{% load static %}


{% block title %}
<!-- <link rel="stylesheet" href="{% static 'css/matching_list.css' %}" type="text/css"/> -->
{% endblock %}

{% block content %}
<div class="mainpage">
    <!-- 방목록 -->
    <div class="matchinglist-container">
        <div class="matchingroom-container">
            <div class="selected_date">
                <form action="{% url 'matching:main' %}" class="main-date-choose" method="get">
                    <label for="selected_date"></label>
                    <input type="date" class="main-date-input" id="selected_date" name="selected_date" value="{{request.Get.selected_date}}" min="" max="2023-09-14">
                    <input type="submit" class="main-date-click" value="선택">
                </form>
            </div>
            <!-- 부대위치와 방생성 -->
            <div class="matchinglist-info">
                {% if user.is_authenticated %}
                    <!-- 로그인한 사용자의 경우에만 보여질 내용 -->
                    <p>{{ user.first_name }}님</p>
                    <!-- 방만들기 -->
                    <a href="/matching/create/"><button type="button" class="btn btn-secondary">
                        방 만들기
                    </button></a>
                {% else %}
                    <a href="/user/main/">로그인</a>
                    <!-- 방만들기 -->
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#login_required_modal">
                        방 만들기
                    </button>
                {% endif %}
            </div>
        
            {% for room in rooms %}
            {% if user.is_authenticated %}
            <div class="matching-room" data-bs-toggle="modal" data-bs-target="#exampleModal-{{ room.id }}">
            {% else %}
            <div class="matching-room" data-bs-toggle="modal" data-bs-target="#login_required_modal">
            {% endif %}
                <div class="matching-room--left">
                    <div class="matching-room--left-top-m">
                        <h2 class="matching-room--left-1">
                            {{ room.departure_date }}
                        </h2>
                        <h2 class="matching-room--left-2">
                            {{ room.departure_time }}
                        </h2>
                    </div>
                    <h2 class="matching-room--left-3">
                       {{ room.current_num }} / {{ room.max_num }}
                    </h2>
                </div>
                <div class="matching-room--right">
                    <div class="matching--departure">
                        <span>출발: {{ room.departure_area }}</span>
                        <span>도착: {{ room.destination_area }}</span>
                        {% if room in is_host %}
                            <div class="host-icon-box">
                                <div class="host-icon"></div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% endfor %}

            <!-- Modals -->
            {% for room in rooms %}
            <div class="modal fade" id="exampleModal-{{ room.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        {% if room in is_host %} <!--해당 방의 방장일 때-->
                        <div class="matchinglist-modal-body">
                            <img class="taxiimg" src="{% static 'img/taxiimg.png' %}">
                            <h3>매칭방을<br>수정하시겠습니까?</h3>
                        </div>
                        <div class="matchinglist-modal-footer">                            
                            <a href="/matching/update/room/{{ room.id }}"><button type="button" class="btn btn-primary" id="matching-button">수정</button></a>
                        </div>
                        {% elif room.id in already_apply_ids %} <!--이미 신청한 방일 때-->    
                        <div class="matchinglist-modal-body">
                            <img class="taxiimg" src="{% static 'img/taxiimg.png' %}">
                            <h3>채팅방으로<br>이동하기</h3>
                        </div>
                        <div class="matchinglist-modal-footer">                            
                            <a href="/chat/{{ room.uuid }}/"><button type="button" class="btn btn-primary" id="matching-button">채팅방 이동</button></a>
                        </div>
                        {% else %} <!--해당 방의 게스트일 때-->
                        <div class="matchinglist-modal-body">
                            <img class="taxiimg" src="{% static 'img/taxiimg.png' %}">
                            <h3>매칭에<br>참여하시겠습니까?</h3>
                        </div>
                        <div class="matchinglist-modal-footer">   
                            <a href="/matching/apply/room/{{ room.id }}"><button type="button" class="btn btn-primary" id="matching-button">매칭 참여하기</button></a>
                        </div>    
                        {% endif %}     
                            <!--<script>
                                $(document).ready(function() {
                                    $(".matching-room").click(function() {
                                        var alreadyApply = {{ already_apply|yesno:"true,false" }};
                                        var currentNum = {{ room.current_num }};
                                        var maxNum = {{ room.max_num }};
                                        
                                        if (alreadyApply || currentNum === maxNum) {
                                            alert("매칭방이 가득 찼거나 이미 신청하셨습니다.");
                            
                                        }
                                    });
                                });
                            </script>       -->                                                      
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    const currentDate = new Date();
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const monthh = String(currentDate.getMonth() + 2).padStart(2, '0');
    const day = String(currentDate.getDate()).padStart(2, '0');
    const minDate = `${year}-${month}-${day}`;
    const maxDate = `${year}-${monthh}-${day}`;

    const selectedDateInput = document.getElementById('selected_date');
    selectedDateInput.min = minDate;
    selectedDateInput.max = maxDate;
</script>
{% endblock %}
